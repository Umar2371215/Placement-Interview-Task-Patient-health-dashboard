<!DOCTYPE html>
<html>
<head>
  <title>Patient Health Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    :root {
      --primary: #4285f4;
      --secondary: #34a853;
      --danger: #ea4335;
      --warning: #fbbc05;
      --light-gray: #f5f5f5;
      --dark-gray: #333;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      color: #333;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: var(--primary);
      color: white;
      padding: 20px 0;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .header-actions {
      position: absolute;
      right: 20px;
      top: 20px;
      display: flex;
      gap: 10px;
    }
    
    .export-btn {
      background: white;
      color: var(--primary);
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    h1 {
      margin: 0;
      font-size: 2.2rem;
    }
    
    .subtitle {
      font-weight: normal;
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .view-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }
    
    .tab-btn {
      padding: 12px 24px;
      background: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab-btn.active {
      border-bottom: 3px solid var(--primary);
      color: var(--primary);
    }
    
    .tab-btn:first-child {
      border-radius: 5px 0 0 5px;
    }
    
    .tab-btn:last-child {
      border-radius: 0 5px 5px 0;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: all 0.3s;
      position: relative;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    .card-icon {
      font-size: 24px;
      color: var(--primary);
    }
    
    .card-value {
      font-size: 28px;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .card-footer {
      font-size: 14px;
      color: #666;
    }
    
    .card-tooltip {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #999;
      cursor: help;
    }
    
    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      position: relative;
    }
    
    .chart-actions {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }
    
    .chart-action-btn {
      background: var(--light-gray);
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .chart-action-btn:hover {
      background: var(--primary);
      color: white;
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 20px 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    
    th, td {
      border: 1px solid #e0e0e0;
      padding: 12px 15px;
      text-align: left;
    }
    
    th {
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .nested-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .nested-table td {
      border: none;
      padding: 4px 8px;
      font-size: 14px;
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      font-size: 18px;
      color: #666;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-right: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      color: var(--danger);
      text-align: center;
      padding: 20px;
      font-size: 16px;
    }
    
    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .filter-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-container input, .filter-container select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-width: 150px;
    }
    
    .filter-container button {
      padding: 8px 16px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 14px;
      font-weight: normal;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    .retry-btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .alert-banner {
      background-color: var(--danger);
      color: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .alert-banner.warning {
      background-color: var(--warning);
      color: var(--dark-gray);
    }
    
    .alert-close {
      background: none;
      border: none;
      color: inherit;
      font-size: 20px;
      cursor: pointer;
    }
    
    @media (max-width: 768px) {
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      .comparison-container {
        grid-template-columns: 1fr;
      }
      
      .filter-container {
        flex-direction: column;
      }
      
      .header-actions {
        position: static;
        justify-content: center;
        margin-top: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Patient Health Dashboard</h1>
      <p class="subtitle">Comprehensive view of patient health metrics</p>
      <div class="header-actions">
        <button class="export-btn" id="export-pdf">
          <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button class="export-btn" id="export-csv">
          <i class="fas fa-file-csv"></i> Export CSV
        </button>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="alert-banner" class="alert-banner" style="display: none;">
      <span id="alert-message"></span>
      <button class="alert-close" onclick="document.getElementById('alert-banner').style.display = 'none'">
        &times;
      </button>
    </div>

    <div class="view-tabs">
      <button class="tab-btn active" onclick="showTab('dashboard')">
        <i class="fas fa-tachometer-alt"></i> Dashboard
      </button>
      <button class="tab-btn" onclick="showTab('charts')">
        <i class="fas fa-chart-line"></i> Trends
      </button>
      <button class="tab-btn" onclick="showTab('table')">
        <i class="fas fa-table"></i> Detailed Data
      </button>
    </div>

    <div id="dashboard" class="tab-content active">
      <div class="dashboard-cards">
        <div class="card">
          <div class="card-tooltip tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltiptext">Average daily steps over the period. Recommended: 7,000-10,000 steps/day</span>
          </div>
          <div class="card-header">
            <h3 class="card-title">Average Steps</h3>
            <i class="fas fa-walking card-icon"></i>
          </div>
          <div class="card-value" id="avg-steps">-</div>
          <div class="card-footer">Last 30 days</div>
        </div>
        
        <div class="card">
          <div class="card-tooltip tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltiptext">Sleep quality score (0-10) based on duration, interruptions, and self-reported quality</span>
          </div>
          <div class="card-header">
            <h3 class="card-title">Sleep Quality</h3>
            <i class="fas fa-bed card-icon"></i>
          </div>
          <div class="card-value" id="avg-sleep-quality">-</div>
          <div class="card-footer">Average score (0-10)</div>
        </div>
        
        <div class="card">
          <div class="card-tooltip tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltiptext">Average heart rate in beats per minute. Normal range: 60-100 bpm</span>
          </div>
          <div class="card-header">
            <h3 class="card-title">Heart Rate</h3>
            <i class="fas fa-heartbeat card-icon"></i>
          </div>
          <div class="card-value" id="avg-heart-rate">-</div>
          <div class="card-footer">Average bpm</div>
        </div>
        
        <div class="card">
          <div class="card-tooltip tooltip">
            <i class="fas fa-info-circle"></i>
            <span class="tooltiptext">Average daily calorie intake. Recommended: 2,000-2,500 calories/day</span>
          </div>
          <div class="card-header">
            <h3 class="card-title">Daily Calories</h3>
            <i class="fas fa-utensils card-icon"></i>
          </div>
          <div class="card-value" id="avg-calories">-</div>
          <div class="card-footer">Recommended: 2000-2500</div>
        </div>
      </div>

      <div class="comparison-container">
        <div class="chart-container">
          <div class="chart-actions">
            <button class="chart-action-btn tooltip" onclick="exportChart('activitySleep')">
              <i class="fas fa-download"></i>
              <span class="tooltiptext">Download this chart</span>
            </button>
          </div>
          <h3 class="chart-title">Activity vs Sleep Duration</h3>
          <canvas id="activity-sleep-chart"></canvas>
        </div>
        
        <div class="chart-container">
          <div class="chart-actions">
            <button class="chart-action-btn tooltip" onclick="exportChart('nutrition')">
              <i class="fas fa-download"></i>
              <span class="tooltiptext">Download this chart</span>
            </button>
          </div>
          <h3 class="chart-title">Nutrition Breakdown</h3>
          <canvas id="nutrition-chart"></canvas>
        </div>
      </div>
    </div>

    <div id="charts" class="tab-content">
      <div class="chart-container">
        <div class="chart-actions">
          <button class="chart-action-btn tooltip" onclick="exportChart('heartRate')">
            <i class="fas fa-download"></i>
            <span class="tooltiptext">Download this chart</span>
          </button>
        </div>
        <h3 class="chart-title">Heart Rate Trend</h3>
        <canvas id="heart-rate-chart"></canvas>
      </div>
      
      <div class="chart-container">
        <div class="chart-actions">
          <button class="chart-action-btn tooltip" onclick="exportChart('steps')">
            <i class="fas fa-download"></i>
            <span class="tooltiptext">Download this chart</span>
          </button>
        </div>
        <h3 class="chart-title">Step Count Over Time</h3>
        <canvas id="steps-chart"></canvas>
      </div>
      
      <div class="chart-container">
        <div class="chart-actions">
          <button class="chart-action-btn tooltip" onclick="exportChart('sleepQuality')">
            <i class="fas fa-download"></i>
            <span class="tooltiptext">Download this chart</span>
          </button>
        </div>
        <h3 class="chart-title">Sleep Quality Trend</h3>
        <canvas id="sleep-quality-chart"></canvas>
      </div>
    </div>

    <div id="table" class="tab-content">
      <div class="filter-container">
        <input type="text" id="search" placeholder="Search by date...">
        <input type="date" id="start-date" placeholder="Start date">
        <input type="date" id="end-date" placeholder="End date">
        <select id="health-filter">
          <option value="">All Health Status</option>
          <option value="Good">Good</option>
          <option value="Moderate">Moderate</option>
          <option value="Poor">Poor</option>
        </select>
        <button onclick="applyFilters()">
          <i class="fas fa-filter"></i> Apply Filters
        </button>
        <button onclick="resetFilters()">
          <i class="fas fa-redo"></i> Reset
        </button>
      </div>
      
      <table id="patient-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Activity</th>
            <th>Sleep</th>
            <th>Nutrition</th>
            <th>Vitals</th>
            <th>Health Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="6" class="loading">
              <div class="spinner"></div>
              Loading patient data...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB3-pM-dr_HGXpLyE-vxXCrJn8vPUnw37Q",
      authDomain: "rn-firebase-ml-test.firebaseapp.com",
      databaseURL: "https://rn-firebase-ml-test-default-rtdb.firebaseio.com",
      projectId: "rn-firebase-ml-test",
      storageBucket: "rn-firebase-ml-test.firebasestorage.app",
      messagingSenderId: "964593574138",
      appId: "1:964593574138:web:815a05431b322d81312943",
      measurementId: "G-CR54SS9S8P"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const collectionRef = db.collection('patientData');
    
    // DOM elements
    const tbody = document.querySelector('#patient-table tbody');
    let allPatientData = [];
    let charts = {};
    let hasPoorHealthDays = false;

    // Helper function to check if a value is valid
    function isValid(value) {
      return value !== undefined && value !== null && value !== '';
    }

    // Function to calculate mean from various data formats
    function calculateMean(value) {
      if (!isValid(value)) return null;
      
      if (Array.isArray(value)) {
        const nums = value.map(Number).filter(n => !isNaN(n));
        return nums.length ? nums.reduce((a, b) => a + b, 0) / nums.length : null;
      }
      
      if (typeof value === 'string' && value.includes('|')) {
        const values = value.split('|').map(Number).filter(n => !isNaN(n));
        return values.length ? values.reduce((a, b) => a + b, 0) / values.length : null;
      }
      
      const num = Number(value);
      return isNaN(num) ? null : num;
    }

    // Function to calculate blood pressure categories
    function getBloodPressureStatus(systolic, diastolic) {
      if (systolic >= 140 || diastolic >= 90) return 'High';
      if (systolic >= 130 || diastolic >= 80) return 'Elevated';
      if (systolic >= 120) return 'Normal';
      return 'Optimal';
    }

    // Function to convert sleep quality text to numerical value
    function sleepQualityToNumber(quality) {
      if (!isValid(quality)) return 0;
      switch(quality.toLowerCase()) {
        case 'poor': return 3;
        case 'fair': return 5;
        case 'good': return 7;
        case 'excellent': return 9;
        default: return 0;
      }
    }

    // Function to determine health category
    function determineHealthCategory(patient) {
      if (!patient) return 'Unknown';
      
      let score = 0;
      
      const hrMean = calculateMean(patient.vitals?.heart_rate);
      if (hrMean && (hrMean < 60 || hrMean > 100)) score += 1;
      
      const bpValues = patient.vitals?.blood_pressure;
      if (bpValues) {
        const bpArray = Array.isArray(bpValues) ? bpValues : [bpValues];
        const bpStatus = bpArray.map(bp => {
          if (typeof bp === 'string' && bp.includes('/')) {
            const [systolic, diastolic] = bp.split('/').map(Number);
            return getBloodPressureStatus(systolic, diastolic);
          }
          return 'Unknown';
        });
        
        if (bpStatus.includes('High')) score += 2;
        else if (bpStatus.includes('Elevated')) score += 1;
      }
      
      if (patient.sleep?.duration_hours < 6) score += 1;
      else if (patient.sleep?.duration_hours < 7) score += 0.5;
      
      if (patient.sleep?.interruptions > 2) score += 1;
      
      const sleepQuality = patient.sleep?.quality;
      if (sleepQuality === 'poor') score += 1;
      else if (sleepQuality === 'fair') score += 0.5;
      
      if (patient.activity?.steps < 5000) score += 1;
      else if (patient.activity?.steps < 7000) score += 0.5;
      
      if (score === 0) return 'Good';
      if (score <= 2) return 'Moderate';
      return 'Poor';
    }

    // Format array data for display
    function formatArray(arr) {
      if (!arr || !arr.length) return 'N/A';
      if (Array.isArray(arr)) return arr.join(', ');
      return arr;
    }

    // Format date for display
    function formatDate(dateString) {
      if (!dateString) return 'Unknown Date';
      try {
        const date = new Date(dateString);
        return isNaN(date.getTime()) ? dateString : date.toLocaleDateString();
      } catch {
        return dateString;
      }
    }

    // Format vital sign data for display
    function formatVitals(vitals) {
      if (!vitals) return 'N/A';
      
      let heartRate = vitals.heart_rate;
      if (Array.isArray(heartRate)) {
        heartRate = heartRate.join(', ');
      } else if (typeof heartRate === 'string' && heartRate.includes('|')) {
        heartRate = heartRate.split('|').join(', ');
      }
      
      let bloodPressure = vitals.blood_pressure;
      if (Array.isArray(bloodPressure)) {
        bloodPressure = bloodPressure.join(', ');
      }
      
      let temperature = vitals.temperature;
      if (Array.isArray(temperature)) {
        temperature = temperature.join(', ');
      } else if (typeof temperature === 'string' && temperature.includes('|')) {
        temperature = temperature.split('|').join(', ');
      }
      
      return {
        heartRate: heartRate || 'N/A',
        bloodPressure: bloodPressure || 'N/A',
        temperature: temperature || 'N/A'
      };
    }

    // Render a single patient row
    function renderPatientRow(data) {
      const tr = document.createElement('tr');
      const healthStatus = determineHealthCategory(data);
      const vitals = formatVitals(data.vitals);

      if (healthStatus === 'Poor') hasPoorHealthDays = true;

      const dateCell = document.createElement('td');
      dateCell.textContent = formatDate(data.date);
      tr.appendChild(dateCell);

      const activityCell = document.createElement('td');
      activityCell.innerHTML = `
        <table class="nested-table">
          <tr><td>Steps:</td><td>${data.activity?.steps || 'N/A'}</td></tr>
          <tr><td>Active Minutes:</td><td>${data.activity?.active_minutes || 'N/A'}</td></tr>
          <tr><td>Sedentary Hours:</td><td>${data.activity?.sedentary_hours || 'N/A'}</td></tr>
        </table>`;
      tr.appendChild(activityCell);

      const sleepCell = document.createElement('td');
      sleepCell.innerHTML = `
        <table class="nested-table">
          <tr><td>Duration (hours):</td><td>${data.sleep?.duration_hours || 'N/A'}</td></tr>
          <tr><td>Interruptions:</td><td>${data.sleep?.interruptions || 'N/A'}</td></tr>
          <tr><td>Quality:</td><td>${data.sleep?.quality || 'N/A'}</td></tr>
        </table>`;
      tr.appendChild(sleepCell);

      const nutritionCell = document.createElement('td');
      const macros = data.nutrition?.macros || {};
      nutritionCell.innerHTML = `
        <table class="nested-table">
          <tr><td>Calories:</td><td>${data.nutrition?.calories || 'N/A'}</td></tr>
          <tr><td>Water (oz):</td><td>${data.nutrition?.water_oz || 'N/A'}</td></tr>
          <tr><td>Macros:</td><td>
            <table class="nested-table">
              <tr><td>Carbs (g):</td><td>${macros.carbs_g || 'N/A'}</td></tr>
              <tr><td>Protein (g):</td><td>${macros.protein_g || 'N/A'}</td></tr>
              <tr><td>Fat (g):</td><td>${macros.fat_g || 'N/A'}</td></tr>
            </table>
          </td></tr>
        </table>`;
      tr.appendChild(nutritionCell);

      const vitalsCell = document.createElement('td');
      vitalsCell.innerHTML = `
        <table class="nested-table">
          <tr><td>Temperature (Â°F):</td><td>${vitals.temperature}</td></tr>
          <tr><td>Heart Rate (bpm):</td><td>${vitals.heartRate}</td></tr>
          <tr><td>Blood Pressure:</td><td>${vitals.bloodPressure}</td></tr>
        </table>`;
      tr.appendChild(vitalsCell);

      const healthCell = document.createElement('td');
      healthCell.textContent = healthStatus;
      healthCell.style.fontWeight = 'bold';
      if (healthStatus === 'Good') healthCell.style.color = 'var(--secondary)';
      else if (healthStatus === 'Moderate') healthCell.style.color = 'var(--warning)';
      else healthCell.style.color = 'var(--danger)';
      tr.appendChild(healthCell);

      return tr;
    }

    // Apply filters to table
    function applyFilters() {
      const searchTerm = document.getElementById('search').value.toLowerCase();
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      const healthFilter = document.getElementById('health-filter').value;
      
      const filtered = allPatientData.filter(patient => {
        if (searchTerm && !formatDate(patient.date).toLowerCase().includes(searchTerm)) {
          return false;
        }
        
        const patientDate = new Date(patient.date);
        if (startDate && patientDate < new Date(startDate)) {
          return false;
        }
        if (endDate && patientDate > new Date(endDate)) {
          return false;
        }
        
        if (healthFilter) {
          const status = determineHealthCategory(patient);
          if (status !== healthFilter) return false;
        }
        
        return true;
      });
      
      renderTable(filtered);
    }

    // Reset all filters
    function resetFilters() {
      document.getElementById('search').value = '';
      document.getElementById('start-date').value = '';
      document.getElementById('end-date').value = '';
      document.getElementById('health-filter').value = '';
      renderTable(allPatientData);
    }

    // Render all patient data in table
    function renderTable(data) {
      tbody.innerHTML = '';
      hasPoorHealthDays = false;
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No patient data available matching filters</td></tr>';
        return;
      }
      
      data.forEach(patient => {
        tbody.appendChild(renderPatientRow(patient));
      });

      if (hasPoorHealthDays) {
        const alertBanner = document.getElementById('alert-banner');
        const alertMessage = document.getElementById('alert-message');
        alertBanner.style.display = 'flex';
        alertMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Warning: Some days show poor health status. Please review these entries.';
      }
    }

    // Calculate averages for dashboard cards
    function calculateAverages(data) {
      if (!data || data.length === 0) {
        return {
          avgSteps: 0,
          avgSleepQuality: 0,
          avgHeartRate: 0,
          avgCalories: 0
        };
      }
      
      const stats = {
        steps: 0,
        sleepQuality: 0,
        heartRate: 0,
        calories: 0,
        count: data.length
      };
      
      data.forEach(patient => {
        stats.steps += patient.activity?.steps || 0;
        stats.sleepQuality += sleepQualityToNumber(patient.sleep?.quality);
        
        const hrMean = calculateMean(patient.vitals?.heart_rate);
        if (hrMean) stats.heartRate += hrMean;
        
        stats.calories += patient.nutrition?.calories || 0;
      });
      
      return {
        avgSteps: Math.round(stats.steps / stats.count),
        avgSleepQuality: (stats.sleepQuality / stats.count).toFixed(1),
        avgHeartRate: stats.count > 0 ? Math.round(stats.heartRate / stats.count) : 0,
        avgCalories: Math.round(stats.calories / stats.count)
      };
    }

    // Create charts
    function createCharts(data) {
      if (!data || data.length === 0) {
        console.warn("No data available to create charts");
        return;
      }
      
      const sortedData = [...data].sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateA - dateB;
      });
      
      const dates = sortedData.map(d => formatDate(d.date));
      
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });
      
      // Heart Rate Chart
      const heartRateCtx = document.getElementById('heart-rate-chart').getContext('2d');
      charts.heartRate = new Chart(heartRateCtx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Heart Rate (bpm)',
            data: sortedData.map(d => calculateMean(d.vitals?.heart_rate)),
            borderColor: 'rgba(234, 67, 53, 0.8)',
            backgroundColor: 'rgba(234, 67, 53, 0.1)',
            tension: 0.3,
            fill: true,
            pointBackgroundColor: sortedData.map(d => {
              const status = determineHealthCategory(d);
              if (status === 'Good') return '#34a853';
              if (status === 'Moderate') return '#fbbc05';
              return '#ea4335';
            }),
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Avg: ${context.raw ? context.raw.toFixed(0) : 'N/A'} bpm`;
                },
                afterLabel: function(context) {
                  const data = sortedData[context.dataIndex];
                  return `Status: ${determineHealthCategory(data)}`;
                }
              }
            }
          },
          scales: {
            y: {
              title: { display: true, text: 'BPM' }
            }
          }
        }
      });
      
      // Steps Chart
      const stepsCtx = document.getElementById('steps-chart').getContext('2d');
      charts.steps = new Chart(stepsCtx, {
        type: 'bar',
        data: {
          labels: dates,
          datasets: [{
            label: 'Steps',
            data: sortedData.map(d => d.activity?.steps || 0),
            backgroundColor: sortedData.map(d => {
              const status = determineHealthCategory(d);
              if (status === 'Good') return 'rgba(52, 168, 83, 0.7)';
              if (status === 'Moderate') return 'rgba(251, 188, 5, 0.7)';
              return 'rgba(234, 67, 53, 0.7)';
            })
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false },
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  const data = sortedData[context.dataIndex];
                  return `Status: ${determineHealthCategory(data)}`;
                }
              }
            }
          },
          scales: {
            y: {
              title: { display: true, text: 'Steps' }
            }
          }
        }
      });
      
      // Sleep Quality Chart
      const sleepQualityCtx = document.getElementById('sleep-quality-chart').getContext('2d');
      charts.sleepQuality = new Chart(sleepQualityCtx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Sleep Quality',
            data: sortedData.map(d => sleepQualityToNumber(d.sleep?.quality)),
            borderColor: 'rgba(52, 168, 83, 0.8)',
            backgroundColor: 'rgba(52, 168, 83, 0.1)',
            tension: 0.3,
            fill: true,
            pointBackgroundColor: sortedData.map(d => {
              const status = determineHealthCategory(d);
              if (status === 'Good') return '#34a853';
              if (status === 'Moderate') return '#fbbc05';
              return '#ea4335';
            }),
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false },
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  const data = sortedData[context.dataIndex];
                  return `Status: ${determineHealthCategory(data)}`;
                }
              }
            }
          },
          scales: {
            y: {
              min: 0,
              max: 10,
              title: { display: true, text: 'Quality Score' }
            }
          }
        }
      });
      
      // Activity vs Sleep Chart
      const activitySleepCtx = document.getElementById('activity-sleep-chart').getContext('2d');
      charts.activitySleep = new Chart(activitySleepCtx, {
        type: 'bar',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Steps',
              data: sortedData.map(d => d.activity?.steps || 0),
              backgroundColor: 'rgba(66, 133, 244, 0.7)',
              yAxisID: 'y'
            },
            {
              label: 'Sleep Hours',
              data: sortedData.map(d => d.sleep?.duration_hours || 0),
              backgroundColor: 'rgba(52, 168, 83, 0.7)',
              type: 'line',
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false },
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  const data = sortedData[context.dataIndex];
                  return `Status: ${determineHealthCategory(data)}`;
                }
              }
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Steps' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Hours' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
      
      // Nutrition Chart
      const nutritionCtx = document.getElementById('nutrition-chart').getContext('2d');
      charts.nutrition = new Chart(nutritionCtx, {
        type: 'doughnut',
        data: {
          labels: ['Carbs', 'Protein', 'Fat'],
          datasets: [{
            data: [
              sortedData.reduce((sum, d) => sum + (d.nutrition?.macros?.carbs_g || 0), 0),
              sortedData.reduce((sum, d) => sum + (d.nutrition?.macros?.protein_g || 0), 0),
              sortedData.reduce((sum, d) => sum + (d.nutrition?.macros?.fat_g || 0), 0)
            ],
            backgroundColor: [
              'rgba(251, 188, 5, 0.7)',
              'rgba(66, 133, 244, 0.7)',
              'rgba(234, 67, 53, 0.7)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: {
              display: true,
              text: 'Macronutrient Distribution',
              font: { size: 16 }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const value = context.raw;
                  const percentage = Math.round((value / total) * 100);
                  return `${context.label}: ${value}g (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Export chart as image
    function exportChart(chartKey) {
      const chart = charts[chartKey];
      if (!chart) {
        console.error(`Chart with key ${chartKey} not found`);
        return;
      }
      
      const link = document.createElement('a');
      link.download = `${chartKey}-${new Date().toISOString().slice(0,10)}.png`;
      link.href = chart.toBase64Image();
      link.click();
    }

    // Export dashboard as PDF
    async function exportToPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        let yPos = 20;
        
        // Add title
        doc.setFontSize(20);
        doc.setTextColor(40);
        doc.text('Patient Health Dashboard Report', 105, yPos, { align: 'center' });
        yPos += 10;
        
        doc.setFontSize(12);
        doc.text(`Generated on ${new Date().toLocaleDateString()}`, 105, yPos, { align: 'center' });
        yPos += 20;
        
        // Add summary cards
        doc.setFontSize(14);
        doc.text('Summary Metrics', 14, yPos);
        yPos += 10;
        
        const cardData = [
          { title: 'Average Steps', value: document.getElementById('avg-steps').textContent },
          { title: 'Sleep Quality', value: document.getElementById('avg-sleep-quality').textContent },
          { title: 'Heart Rate', value: document.getElementById('avg-heart-rate').textContent },
          { title: 'Daily Calories', value: document.getElementById('avg-calories').textContent }
        ];
        
        let x = 14;
        cardData.forEach((card, i) => {
          doc.setFillColor(255, 255, 255);
          doc.rect(x, yPos, 45, 25, 'F');
          doc.rect(x, yPos, 45, 25);
          
          doc.setFontSize(10);
          doc.text(card.title, x + 23, yPos + 10, { align: 'center' });
          doc.setFontSize(12);
          doc.text(card.value, x + 23, yPos + 20, { align: 'center' });
          
          x += 48;
          if (i === 1) {
            x = 14;
            yPos += 30;
          }
        });
        
        yPos += 40;
        
        // Add charts
        const chartIds = ['activity-sleep-chart', 'nutrition-chart', 'heart-rate-chart', 'steps-chart', 'sleep-quality-chart'];
        
        for (const chartId of chartIds) {
          const canvas = document.getElementById(chartId);
          if (!canvas) continue;
          
          const chart = Chart.getChart(canvas);
          if (!chart) continue;
          
          // Add chart title
          const title = document.querySelector(`#${chartId} .chart-title`)?.textContent || chartId;
          doc.setFontSize(14);
          doc.text(title, 105, yPos, { align: 'center' });
          yPos += 10;
          
          // Add chart image
          const imgData = chart.toBase64Image('image/png', 1);
          const imgWidth = 180;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          doc.addImage(imgData, 'PNG', (210 - imgWidth) / 2, yPos, imgWidth, imgHeight);
          yPos += imgHeight + 20;
          
          // Add new page if needed
          if (yPos > 250) {
            doc.addPage();
            yPos = 20;
          }
        }
        
        // Save the PDF
        doc.save(`patient-health-dashboard-${new Date().toISOString().slice(0,10)}.pdf`);
      } catch (error) {
        console.error("Error generating PDF:", error);
        alert("Error generating PDF. Please try again or check console for details.");
      }
    }

    // Export data as CSV
    function exportToCSV() {
      if (!allPatientData || allPatientData.length === 0) return;
      
      let csvContent = "Date,Steps,Active Minutes,Sedentary Hours,Sleep Hours,Sleep Interruptions,Sleep Quality,Calories,Water (oz),Carbs (g),Protein (g),Fat (g),Heart Rate,Blood Pressure,Temperature,Health Status\n";
      
      allPatientData.forEach(patient => {
        const row = [
          formatDate(patient.date),
          patient.activity?.steps || '',
          patient.activity?.active_minutes || '',
          patient.activity?.sedentary_hours || '',
          patient.sleep?.duration_hours || '',
          patient.sleep?.interruptions || '',
          patient.sleep?.quality || '',
          patient.nutrition?.calories || '',
          patient.nutrition?.water_oz || '',
          patient.nutrition?.macros?.carbs_g || '',
          patient.nutrition?.macros?.protein_g || '',
          patient.nutrition?.macros?.fat_g || '',
          formatArray(patient.vitals?.heart_rate),
          formatArray(patient.vitals?.blood_pressure),
          formatArray(patient.vitals?.temperature),
          determineHealthCategory(patient)
        ].map(field => `"${field}"`).join(',');
        
        csvContent += row + '\n';
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `patient-health-data-${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Update dashboard cards
    function updateDashboardCards(averages) {
      document.getElementById('avg-steps').textContent = averages.avgSteps.toLocaleString();
      document.getElementById('avg-sleep-quality').textContent = averages.avgSleepQuality;
      document.getElementById('avg-heart-rate').textContent = averages.avgHeartRate;
      document.getElementById('avg-calories').textContent = averages.avgCalories.toLocaleString();
      
      const stepsElement = document.getElementById('avg-steps');
      if (averages.avgSteps < 5000) stepsElement.style.color = 'var(--danger)';
      else if (averages.avgSteps < 7000) stepsElement.style.color = 'var(--warning)';
      else stepsElement.style.color = 'var(--secondary)';
      
      const sleepElement = document.getElementById('avg-sleep-quality');
      if (averages.avgSleepQuality < 5) sleepElement.style.color = 'var(--danger)';
      else if (averages.avgSleepQuality < 7) sleepElement.style.color = 'var(--warning)';
      else sleepElement.style.color = 'var(--secondary)';
      
      const hrElement = document.getElementById('avg-heart-rate');
      if (averages.avgHeartRate < 60 || averages.avgHeartRate > 100) hrElement.style.color = 'var(--danger)';
      else hrElement.style.color = 'var(--secondary)';
      
      const caloriesElement = document.getElementById('avg-calories');
      if (averages.avgCalories < 1800 || averages.avgCalories > 2500) caloriesElement.style.color = 'var(--danger)';
      else if (averages.avgCalories < 2000 || averages.avgCalories > 2300) caloriesElement.style.color = 'var(--warning)';
      else caloriesElement.style.color = 'var(--secondary)';
    }

    // Tab switching
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
      
      if (tabId === 'charts' && allPatientData.length > 0) {
        createCharts(allPatientData);
      }
    }

    // Initialize the app
    function init() {
      tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Loading patient data...</td></tr>';
      
      collectionRef.get().then(snapshot => {
        if (snapshot.empty) {
          throw new Error("No data available in Firebase");
        }
        
        allPatientData = snapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            date: data.date || 'Unknown Date',
            activity: data.activity || {
              steps: 0,
              active_minutes: 0,
              sedentary_hours: 0
            },
            sleep: data.sleep || {
              duration_hours: 0,
              interruptions: 0,
              quality: 'unknown'
            },
            nutrition: data.nutrition || {
              calories: 0,
              water_oz: 0,
              macros: {
                carbs_g: 0,
                protein_g: 0,
                fat_g: 0
              }
            },
            vitals: data.vitals || {
              heart_rate: '0',
              blood_pressure: '0/0',
              temperature: '0'
            }
          };
        });
        
        processData();
        
      }).catch(error => {
        console.error("Error fetching from Firebase:", error);
        fetchDataFromAPI();
      });
    }

    // Fallback to REST API if SDK fails
    function fetchDataFromAPI() {
      const projectId = 'rn-firebase-ml-test';
      const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/patientData`;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (!data.documents) {
            throw new Error("No data available via REST API");
          }
          
          allPatientData = data.documents.map(doc => {
            const fields = doc.fields;
            return {
              id: doc.name.split('/').pop(),
              date: fields.date?.stringValue || 'Unknown Date',
              activity: {
                steps: fields.activity?.mapValue?.fields?.steps?.integerValue || 0,
                active_minutes: fields.activity?.mapValue?.fields?.active_minutes?.integerValue || 0,
                sedentary_hours: fields.activity?.mapValue?.fields?.sedentary_hours?.doubleValue || 0
              },
              sleep: {
                duration_hours: fields.sleep?.mapValue?.fields?.duration_hours?.doubleValue || 0,
                interruptions: fields.sleep?.mapValue?.fields?.interruptions?.integerValue || 0,
                quality: fields.sleep?.mapValue?.fields?.quality?.stringValue || 'unknown'
              },
              nutrition: {
                calories: fields.nutrition?.mapValue?.fields?.calories?.integerValue || 0,
                water_oz: fields.nutrition?.mapValue?.fields?.water_oz?.integerValue || 0,
                macros: {
                  carbs_g: fields.nutrition?.mapValue?.fields?.macros?.mapValue?.fields?.carbs_g?.integerValue || 0,
                  protein_g: fields.nutrition?.mapValue?.fields?.macros?.mapValue?.fields?.protein_g?.integerValue || 0,
                  fat_g: fields.nutrition?.mapValue?.fields?.macros?.mapValue?.fields?.fat_g?.integerValue || 0
                }
              },
              vitals: {
                heart_rate: fields.vitals?.mapValue?.fields?.heart_rate?.stringValue || '0',
                blood_pressure: fields.vitals?.mapValue?.fields?.blood_pressure?.stringValue || '0/0',
                temperature: fields.vitals?.mapValue?.fields?.temperature?.stringValue || '0'
              }
            };
          });
          
          processData();
        })
        .catch(error => {
          console.error("Error fetching from REST API:", error);
          tbody.innerHTML = `<tr><td colspan="6" class="error-message">
            Error loading patient data: ${error.message}
            <br><br>
            <button class="retry-btn" onclick="init()">
              <i class="fas fa-sync-alt"></i> Retry
            </button>
          </td></tr>`;
        });
    }

    // Process loaded data
    function processData() {
      allPatientData.forEach(patient => {
        patient.healthStatus = determineHealthCategory(patient);
      });
      
      renderTable(allPatientData);
      
      const averages = calculateAverages(allPatientData);
      updateDashboardCards(averages);
      
      createCharts(allPatientData);
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', () => {
      init();
      
      document.getElementById('export-pdf').addEventListener('click', exportToPDF);
      document.getElementById('export-csv').addEventListener('click', exportToCSV);
    });
  </script>
</body>
</html>